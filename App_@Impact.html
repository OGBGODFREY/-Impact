<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>@Impact Weekly</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css?family=Google+Sans:wght@400;500;700&display-swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0b57d0;
            --primary-bg: #d3e3fd;
            --surface: #ffffff;
            --background: #f0f4f9;
            --text-main: #1f1f1f;
            --text-sub: #444746;
            --brand-gradient: linear-gradient(90deg, #4285f4, #9b72cb, #d96570);
            --radius: 20px;
            --radius-sm: 12px;
            
            /* Couleurs Cat√©gories */
            --col-courses: #34a853;
            --col-trans: #ea4335;   
            --col-digi: #4285f4;    
            --col-elec: #fbbc04;
            --col-coin: #f9ab00; 
            --col-negative: #b3261e;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Google Sans', sans-serif;
            background-color: var(--background);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: 14px;
        }

        /* --- HEADER --- */
        header {
            padding: 8px 16px;
            background: var(--background);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 44px;
            flex-shrink: 0;
        }

        .logo-text {
            font-size: 1.2rem;
            font-weight: 700;
            background: var(--brand-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: inline-block;
            letter-spacing: -0.5px;
        }

        .profile-chip {
            width: 30px; height: 30px; border-radius: 50%;
            background: var(--primary-bg); color: var(--primary);
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 0.9rem; cursor: pointer; border: none;
        }

        /* --- MAIN SCROLL --- */
        #main-scroll {
            flex: 1;
            padding: 0 10px 80px 10px; /* More padding bottom for tab bar */
            display: flex; flex-direction: column;
            overflow-y: auto; scrollbar-width: none;
        }
        #main-scroll::-webkit-scrollbar { display: none; }

        #view-home { height: 100%; display: flex; flex-direction: column; }

        /* --- UI BLOCKS --- */
        
        /* 1. Score & Pi√®ces */
        .sparkle-box {
            background: white; border-radius: var(--radius);
            padding: 10px 14px; margin-bottom: 6px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 1px 4px rgba(0,0,0,0.02); flex-shrink: 0;
            cursor: pointer;
        }
        .big-score { font-size: 1.8rem; font-weight: 700; color: var(--text-main); line-height: 1; }
        .big-coins { font-size: 1.4rem; font-weight: 700; color: var(--col-coin); line-height: 1; }
        .big-coins.negative { color: var(--col-negative); }
        
        .label-sm { font-size: 0.65rem; color: var(--text-sub); text-transform: uppercase; font-weight: 700; }
        
        .comp-val {
            font-size: 0.75rem; color: var(--text-sub); margin-top: 2px;
            min-height: 1.2em; font-weight: 400;
        }

        /* 2. Social Hub Bar */
        .social-bar {
            background: white; border: 1px solid #e0e0e0;
            padding: 8px 12px; border-radius: 12px;
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 6px; cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.02);
            flex-shrink: 0;
        }
        .social-bar-text { font-size: 0.85rem; font-weight: 500; color: var(--text-main); }
        .badge-notif { background: var(--col-trans); color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; font-weight: 700; margin-left: 5px;}

        /* 3. Conseil */
        .advice-card {
            background: #eef2f8; padding: 8px 12px; border-radius: var(--radius-sm);
            margin-bottom: 6px; display: flex; align-items: center; gap: 8px;
            flex-shrink: 0; min-height: 40px;
        }
        .advice-content { font-size: 0.8rem; color: var(--text-sub); line-height: 1.2; flex: 1; }

        /* 4. Carrousel */
        .carousel-wrapper {
            flex: 1; display: flex; flex-direction: column;
            margin-bottom: 6px; min-height: 120px; position: relative;
        }
        .carousel-container {
            flex: 1; display: flex; overflow-x: auto;
            scroll-snap-type: x mandatory; scrollbar-width: none;
            border-radius: 16px;
        }
        .carousel-container::-webkit-scrollbar { display: none; }
        .carousel-slide { min-width: 100%; scroll-snap-align: start; height: 100%; padding: 0 2px; overflow-y: auto; }

        .carousel-dots { display: flex; justify-content: center; gap: 6px; margin-top: 4px; flex-shrink: 0; }
        .dot-nav { width: 6px; height: 6px; border-radius: 50%; background: #ddd; transition: 0.3s; }
        .dot-nav.active { background: var(--text-main); width: 12px; border-radius: 3px; }

        /* Slide 1: Grid COMPACT OPTIMIZED FOR MOBILE */
        .grid-stats { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 6px; height: 100%; 
            grid-auto-rows: 1fr;
        }
        .mini-stat {
            background: white; 
            padding: 4px 8px;
            border-radius: 16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02); 
            cursor: pointer;
            position: relative; 
            overflow: hidden;
            display: flex; 
            flex-direction: column; 
            justify-content: space-between;
            min-height: 55px;
        }
        
        .mini-stat-label { font-size: 0.6rem; font-weight: 700; text-transform: uppercase; margin-bottom: 0px;}
        .mini-stat-val { font-size: 1.1rem; font-weight: 600; color: var(--text-main); line-height: 1.1; margin-bottom: 4px; }
        .progress-bg { height: 4px; background: #eff1f4; border-radius: 3px; overflow: hidden; width: 100%; margin-top: auto; }
        .progress-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
        .mini-stat .comp-val { display: none; } 

        /* Slide 2: Graph SVG */
        .graph-wrapper {
            background: white; border-radius: 16px; padding: 10px 10px 5px 10px;
            height: 100%; width: 100%; box-shadow: 0 2px 6px rgba(0,0,0,0.02);
            display: flex; flex-direction: column;
        }
        .svg-container { flex: 1; width: 100%; position: relative; display: flex; align-items: flex-end; }
        .svg-graph { width: 100%; height: 100%; overflow: visible; }
        .axis-label { font-size: 0.6rem; fill: var(--text-sub); text-anchor: middle; }
        
        /* Slide 4: Amis */
        .friends-wrapper {
            background: white; border-radius: 16px; padding: 15px;
            height: 100%; width: 100%; box-shadow: 0 2px 6px rgba(0,0,0,0.02);
            overflow-y: auto;
        }
        .friend-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 0; border-bottom: 1px solid #f0f0f0;
        }
        .friend-info { display: flex; flex-direction: column; }
        .friend-name { font-weight: 600; font-size: 0.9rem; }
        .friend-email { font-size: 0.7rem; color: var(--text-sub); }
        .friend-req-box {
            background: #fff0e6; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ffdcc5;
        }
        .notif-actions { display: flex; gap: 10px; margin-top: 5px; }
        .btn-xs { border:none; border-radius:12px; padding:4px 10px; font-size:0.75rem; cursor:pointer; }

        /* Slide 5: Valorisation */
        .valo-wrapper {
            background: white; border-radius: 16px; padding: 15px;
            height: 100%; width: 100%; box-shadow: 0 2px 6px rgba(0,0,0,0.02);
            overflow-y: auto;
        }
        .valo-month-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid #f0f0f0;
        }
        .valo-coins { font-weight: 700; color: var(--col-coin); }
        .valo-coins.negative { color: var(--col-negative); }
        
        /* 5. Historique & Semaines */
        .archive-container { flex-shrink: 0; margin-top: 2px; padding-bottom: 5px; }
        .archive-scroll { display: flex; gap: 8px; overflow-x: auto; padding: 4px; scrollbar-width: none; }
        .archive-chip {
            background: white; padding: 6px 12px; border-radius: 20px;
            font-size: 0.75rem; color: var(--text-sub); border: 1px solid #e0e0e0;
            white-space: nowrap; cursor: pointer; transition: 0.2s;
        }
        .archive-chip.active { background: var(--text-main); color: white; border-color: var(--text-main); }
        
        /* Navigation Semaine */
        .week-nav-container {
            margin-bottom: 10px; padding: 4px 0; overflow-x: auto; white-space: nowrap; scrollbar-width: none;
        }
        .week-nav-container::-webkit-scrollbar { display: none; }
        .week-chip {
            display: inline-block; padding: 8px 14px; border-radius: 20px;
            background: #ffffff; margin-right: 6px; font-size: 0.8rem; font-weight: 500;
            color: var(--text-sub); border: 1px solid #d0d7de; cursor: pointer;
        }
        .week-chip.active {
            background: var(--primary); color: white; border-color: var(--primary);
        }

        /* --- COMMON UI --- */
        .card { background: var(--surface); border-radius: var(--radius); padding: 16px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        h3 { margin: 0 0 10px 0; font-weight: 500; font-size: 1rem; }
        .input-group { background: var(--background); border-radius: var(--radius-sm); padding: 8px 12px; margin-bottom: 8px; display: flex; flex-direction: column; position: relative; }
        label { font-size: 0.7rem; color: var(--text-sub); font-weight: 500; }
        .input-bare { border: none; background: transparent; font-size: 1rem; width: 100%; outline: none; }
        .select-compact { width: auto; background: white; padding: 5px 10px; border-radius: 20px; border: 1px solid #ddd; margin-top: 5px; }
        
        .btn { border: none; padding: 12px; border-radius: 50px; font-weight: 500; cursor: pointer; width: 100%; display: flex; justify-content: center; align-items: center; margin-top: 8px; }
        .btn-primary { background: var(--text-main); color: white; }
        .btn-secondary { background: var(--primary-bg); color: var(--primary); }

        /* Sharing updated */
        .share-section { border-top: 1px dashed #ddd; margin-top: 15px; padding-top: 10px; }
        .share-grid { display: flex; gap: 5px; margin-bottom: 8px; }
        .share-opt { flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 8px; background: white; font-size: 0.75rem; text-align: center; cursor: pointer; }
        .share-opt.active { background: var(--text-main); color: white; border-color: var(--text-main); }
        .share-finalize { display: none; margin-top: 8px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #eee; }

        .main-tabs {
            position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%);
            width: 94%; max-width: 400px; height: 55px;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px);
            border-radius: 35px; display: flex; justify-content: space-evenly; align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); z-index: 1000; border: 1px solid rgba(255,255,255,0.6);
        }
        .tab-item { background: none; border: none; padding: 0; color: #80868b; display: flex; flex-direction: column; align-items: center; font-size: 0.65rem; font-weight: 500; cursor: pointer; width: 60px; }
        .tab-item.active { color: var(--primary); font-weight: 700; }
        .tab-icon { font-size: 1.3rem; margin-bottom: 2px; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-card { background: white; border-radius: 24px; padding: 25px; width: 100%; max-width: 340px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); max-height: 85vh; overflow-y: auto; }
        
        .hidden { display: none !important; }
        .sub-nav { display: flex; background: #e0e4e9; padding: 4px; border-radius: 50px; margin-bottom: 12px; }
        .sub-nav button { flex: 1; padding: 6px; border-radius: 40px; border: none; background: transparent; color: var(--text-sub); font-weight: 500; cursor: pointer; font-size: 0.8rem; }
        .sub-nav button.active { background: white; color: var(--text-main); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .country-search-box { position: relative; margin-bottom: 15px; }
        .country-list { max-height: 120px; overflow-y: auto; border: 1px solid #eee; border-radius: 12px; display: none; position: absolute; top: 100%; width: 100%; background: white; z-index: 2500; }
        .country-item { padding: 10px; border-bottom: 1px solid #f9f9f9; cursor: pointer; font-size: 0.9rem; }
        
        .suggestions-list { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #eee; border-radius: 0 0 12px 12px; z-index: 100; max-height: 120px; overflow-y: auto; display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .suggestion-item { padding: 10px; border-bottom: 1px solid #f0f0f0; font-size: 0.85rem; cursor: pointer; background: white; }
        .suggestion-item:hover { background: #f5f5f5; }

        /* Impact Header in Tabs */
        .tab-impact-header {
            text-align: center; padding: 10px; background: white; border-radius: var(--radius); margin-bottom: 10px;
        }
        .tab-impact-val { font-size: 1.8rem; font-weight: 700; }
        .tab-impact-week-label { font-size: 0.8rem; color: var(--text-sub); display:block; margin-top:2px; font-weight: 500;}
        
        /* Auth Toggles */
        .auth-toggle { display: flex; margin-bottom: 15px; background: #f0f4f9; padding: 4px; border-radius: 12px;}
        .auth-toggle button { flex: 1; border: none; background: none; padding: 8px; border-radius: 8px; font-weight: 600; cursor: pointer; color: var(--text-sub); }
        .auth-toggle button.active { background: white; color: var(--text-main); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .forgot-link { font-size: 0.75rem; color: var(--primary); text-decoration: none; display: block; text-align: right; margin-top: 5px; cursor: pointer; }

        .btn-help-data {
            background: none;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 0.85rem;
            cursor: pointer;
            margin-top: 10px;
            display: inline-block;
            transition: background 0.2s;
        }
        .btn-help-data:hover {
            background: var(--primary-bg);
        }
    </style>
</head>
<body>

    <header>
        <div class="logo-text">@Impact</div>
        <button id="auth-btn" class="profile-chip" onclick="toggleAuthModal()">?</button>
    </header>

    <div id="main-scroll">
        
        <div id="view-home">
            
            <div class="sparkle-box" onclick="resetToHomeGrid()">
                <div style="flex:1;">
                    <div style="display:flex; align-items:center; gap:4px; margin-bottom:2px;">
                        <span class="label-sm" data-i18n="bilan_label">BILAN CO‚ÇÇe (Semaine)</span>
                        <span style="font-size: 0.75rem; color: var(--text-sub);" id="display-current-week">05 JAN - 11 JAN</span>
                    </div>
                    <div>
                        <span id="global-score" class="big-score">0.0</span>
                        <span style="font-size: 0.7rem; color: var(--text-sub);">kg</span>
                    </div>
                    <div id="global-score-comp" class="comp-val"></div>
                </div>
                <div style="text-align: right; flex:1; border-left:1px solid #eee; padding-left:10px; cursor: pointer;" onclick="event.stopPropagation(); goToSlide('slide-valo')">
                    <div style="display:flex; align-items:center; justify-content:flex-end; gap:4px; margin-bottom:2px;">
                        <span class="label-sm" style="color:var(--col-coin);" data-i18n="coins_label">PI√àCES</span>
                        <span>ü™ô</span>
                    </div>
                    <div>
                        <span id="global-coins" class="big-coins">1000</span>
                    </div>
                    <div class="comp-val"></div>
                </div>
            </div>

            <div class="social-bar" onclick="goToSlide('slide-friends')">
                <div style="display:flex; align-items:center; gap:8px;">
                    <span style="font-size:1.1rem;">üë•</span>
                    <span class="social-bar-text" data-i18n="friends_share">Amis & Partage</span>
                </div>
                <span id="notif-badge" class="badge-notif hidden">0</span>
                <span style="color:var(--text-sub);">‚ûú</span>
            </div>

            <div class="advice-card">
                <div style="font-size: 1.2rem;">ü§ñ</div>
                <div id="advice-text" class="advice-content">Chargement...</div>
            </div>

            <div class="carousel-wrapper">
                <div class="carousel-container" id="home-carousel" onscroll="updateDots()">
                    
                    <div class="carousel-slide" id="slide-grid">
                        <div class="grid-stats">
                            <div class="mini-stat" onclick="nav('courses', this)">
                                <div>
                                    <div class="mini-stat-label" style="color:var(--col-courses)" data-i18n="cat_courses">COURSES</div>
                                    <div class="mini-stat-val" id="home-val-courses">0.0</div>
                                </div>
                                <div class="progress-bg"><div id="bar-courses" class="progress-fill" style="width:0%; background:var(--col-courses)"></div></div>
                            </div>
                            <div class="mini-stat" onclick="nav('transport', this)">
                                <div>
                                    <div class="mini-stat-label" style="color:var(--col-trans)" data-i18n="cat_transport">TRANSPORT</div>
                                    <div class="mini-stat-val" id="home-val-transport">0.0</div>
                                </div>
                                <div class="progress-bg"><div id="bar-transport" class="progress-fill" style="width:0%; background:var(--col-trans)"></div></div>
                            </div>
                            <div class="mini-stat" onclick="nav('digital', this)">
                                <div>
                                    <div class="mini-stat-label" style="color:var(--col-digi)" data-i18n="cat_digital">DIGITAL</div>
                                    <div class="mini-stat-val" id="home-val-digital">0.0</div>
                                </div>
                                <div class="progress-bg"><div id="bar-digital" class="progress-fill" style="width:0%; background:var(--col-digi)"></div></div>
                            </div>
                            <div class="mini-stat" onclick="nav('elec', this)">
                                <div>
                                    <div class="mini-stat-label" style="color:var(--col-elec)" data-i18n="cat_elec">√âLEC</div>
                                    <div class="mini-stat-val" id="home-val-elec">0.0</div>
                                </div>
                                <div class="progress-bg"><div id="bar-elec" class="progress-fill" style="width:0%; background:var(--col-elec)"></div></div>
                            </div>
                        </div>
                    </div>

                    <div class="carousel-slide" id="slide-graph">
                        <div class="graph-wrapper" style="align-items:center; justify-content:center;">
                            <div style="position:relative; width:120px; height:120px; border-radius:50%; background:#eff1f4; display:flex; align-items:center; justify-content:center; transition: background 0.5s ease;" id="dashboard-donut">
                                <div style="width:80px; height:80px; background:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; z-index:2;" data-i18n="repartition">
                                    R√©part.
                                </div>
                            </div>
                            <div style="display:flex; gap:8px; margin-top:10px; font-size:0.7rem; color:var(--text-sub);">
                                <span><span style="color:var(--col-courses)">‚óè</span> <span data-i18n="cat_courses_short">Courses</span></span>
                                <span><span style="color:var(--col-trans)">‚óè</span> <span data-i18n="cat_trans_short">Transp.</span></span>
                                <span><span style="color:var(--col-digi)">‚óè</span> <span data-i18n="cat_digi_short">Digi</span></span>
                                <span><span style="color:var(--col-elec)">‚óè</span> <span data-i18n="cat_elec_short">√âlec</span></span>
                            </div>
                        </div>
                    </div>

                    <div class="carousel-slide" id="slide-evo">
                        <div class="graph-wrapper">
                            <h4 style="margin:0 0 5px 0; font-size:0.8rem; color:var(--text-sub);" data-i18n="label_evolution">√âvolution (7 Semaines)</h4>
                            <div class="svg-container">
                                <svg id="evo-svg" class="svg-graph" viewBox="0 0 300 120" preserveAspectRatio="none">
                                    </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="carousel-slide" id="slide-friends">
                        <div class="friends-wrapper">
                            <h3 style="margin-bottom:15px;" data-i18n="my_friends">Mes Amis</h3>
                            
                            <div id="invitation-stack"></div>

                            <div class="input-group" style="flex-direction:row; align-items:center; padding:4px 8px; border:1px solid #eee;">
                                <input type="email" id="new-friend-email" class="input-bare" placeholder="Email..." style="font-size:0.85rem;">
                                <button onclick="addFriend()" style="background:var(--primary); color:white; border:none; width:30px; height:30px; border-radius:50%; font-weight:700; cursor:pointer;">+</button>
                            </div>

                            <div id="friends-list" style="margin-top:15px;">
                                </div>
                            
                            <div id="no-friend-msg" style="text-align:center; color:var(--text-sub); font-size:0.8rem; margin-top:20px;" data-i18n="no_friends">
                                Aucun ami ajout√©.
                            </div>
                        </div>
                    </div>

                    <div class="carousel-slide" id="slide-valo">
                        <div class="valo-wrapper">
                            <h3 style="margin-bottom:15px;" data-i18n="coin_val">Valorisation Pi√®ces</h3>
                            <div style="font-size:0.8rem; color:var(--text-sub); margin-bottom:15px;" data-i18n="coin_desc">
                                Les pi√®ces se valorisent chaque semaine.
                            </div>
                            
                            <div id="valo-list">
                                </div>
                        </div>
                    </div>

                </div>
                <div class="carousel-dots">
                    <div class="dot-nav active" id="dot-0"></div>
                    <div class="dot-nav" id="dot-1"></div>
                    <div class="dot-nav" id="dot-2"></div>
                    <div class="dot-nav" id="dot-3"></div>
                    <div class="dot-nav" id="dot-4"></div>
                </div>
            </div>

            <div class="archive-container">
                <h3 style="font-size:0.8rem; margin:0 0 5px 5px; color:var(--text-sub);" data-i18n="historique_title">Historique</h3>
                <div id="archive-list" class="archive-scroll">
                    </div>
            </div>
        </div>

        <div id="view-courses" class="hidden">
            <div class="tab-impact-header">
                <span class="tab-impact-val" id="header-val-courses" style="color:var(--col-courses)">0.0</span> kg CO‚ÇÇe
                <span class="tab-impact-week-label" id="label-week-courses">Total Semaine</span>
            </div>
            <div class="sub-nav">
                <button class="active" onclick="switchCourseSub('budget', this)">üõí <span data-i18n="tab_budget">Budget</span></button>
                <button onclick="switchCourseSub('scanner', this)">üì∑ <span data-i18n="tab_scanner">Scanner</span></button>
            </div>
            <div id="sub-budget">
                <div class="card">
                    <div id="week-nav-courses" class="week-nav-container"></div>

                    <h3 data-i18n="budget_mensuel">Budget Hebdo</h3>
                    <div class="input-group">
                        <label data-i18n="label_regime">ü•ó R√©gime</label>
                        <select id="regime-select" class="input-bare" onchange="calcBudget()">
                            <option value="normal" data-i18n="opt_normal">ü•© Omnivore</option>
                            <option value="vegetarien" data-i18n="opt_vege">üç≥ V√©g√©tarien</option>
                            <option value="vegan" data-i18n="opt_vegan">ü•ó V√©g√©talien</option>
                        </select>
                    </div>
                    <div class="input-group"><label data-i18n="label_food">üõí Alimentation (‚Ç¨)</label><input type="number" id="inp-food" class="input-bare" placeholder="0" oninput="calcBudget()"></div>
                    <div class="input-group"><label data-i18n="label_misc">üé® Autres (‚Ç¨)</label><input type="number" id="inp-misc" class="input-bare" placeholder="0" oninput="calcBudget()"></div>
                    
                    <div class="share-section">
                        <label>ü§ù <span data-i18n="label_share">Partager avec un ami</span></label>
                        <div class="share-grid">
                             <div class="share-opt" onclick="initShareProcess('courses', 0.10, this)">10%</div>
                          <div class="share-opt" onclick="initShareProcess('courses', 0.15, this)">15%</div>
                            <div class="share-opt" onclick="initShareProcess('courses', 0.25, this)">25%</div>
                             <div class="share-opt" onclick="initShareProcess('courses', 0.40, this)">40%</div>
                            <div class="share-opt" onclick="initShareProcess('courses', 0.50, this)">50%</div>
                            <div class="share-opt" onclick="initShareProcess('courses', 0.75, this)">75%</div>
                         <div class="share-opt" onclick="initShareProcess('courses', 0.90, this)">90%</div>
                        </div>
                        
                        <div id="share-finalize-courses" class="share-finalize">
                            <label style="display:block; margin-bottom:4px;" data-i18n="with_whom">Avec qui ?</label>
                            <select id="share-friend-select-courses" class="input-bare" style="font-size:0.8rem; background:white; border:1px solid #ddd; padding:5px; border-radius:8px; margin-bottom:5px;">
                                <option value="" data-i18n="choose_friend">Choisir un ami...</option>
                            </select>
                            <div style="display:flex; gap:5px;">
                                <button class="btn btn-secondary" style="flex:1; padding:6px; margin-top:0;" onclick="cancelShare('courses')" data-i18n="cancel">Annuler</button>
                                <button class="btn btn-primary" style="flex:1; padding:6px; margin-top:0;" onclick="confirmShare('courses')" data-i18n="send">Envoyer</button>
                            </div>
                        </div>
                        <div id="share-status-courses" style="font-size:0.75rem; color:var(--col-courses); text-align:center; display:none; margin-top:5px;"><span data-i18n="share_active">Partage actif</span> (<span id="share-val-courses">0</span>%)</div>
                    </div>
                </div>
            </div>
            
            <div id="sub-scanner" class="hidden">
                <div id="reader" style="border-radius:16px; overflow:hidden;"></div>
                <div class="scanner-ui" id="scanner-start-ui" style="text-align:center; padding:20px;">
                    <button class="btn btn-primary" onclick="startCamera()" data-i18n="btn_scan">üì∑ Scanner</button>
                    <div style="margin-top: 15px; display: flex; gap:10px; justify-content:center;">
                         <input type="text" id="manual-barcode" placeholder="Code..." style="background:#e0e4e9; border:none; padding:10px; border-radius: 20px; width:120px; outline: none;">
                         <button onclick="analyzeManual()" style="background: var(--text-main); color:white; border:none; width:40px; border-radius: 50%; cursor:pointer;">‚ûú</button>
                    </div>
                </div>
                <div id="scan-result" class="card hidden">
                    <button onclick="resetScanner()" style="float:right; border:none; background:none;">‚úï</button>
                    <div style="font-weight:700;" id="res-name" data-i18n="product">Produit</div>
                    <span id="res-co2" style="font-size:1.8rem; font-weight:700;">0.0</span> kg CO‚ÇÇe
                    <div id="res-eco" style="font-size:0.8rem; color:var(--text-sub);"></div>
                </div>
            </div>
        </div>

        <div id="view-transport" class="hidden">
            <div class="tab-impact-header">
                <span class="tab-impact-val" id="header-val-transport" style="color:var(--col-trans)">0.0</span> kg CO‚ÇÇe
                <span class="tab-impact-week-label" id="label-week-transport">Total Semaine</span>
            </div>
            <div class="sub-nav">
                <button id="btn-trans-calc" class="active" onclick="switchTransSub('direct')">üìù <span data-i18n="tab_saisie">Saisie</span></button>
                <button id="btn-trans-route" onclick="switchTransSub('route')">üìç <span data-i18n="tab_itineraire">Itin√©raire</span></button>
            </div>
            <div id="sub-trans-direct">
                <div class="card">
                    <div id="week-nav-transport" class="week-nav-container"></div>

                    <h3 data-i18n="transport_mensuel">Transport Hebdo</h3>
                    <div class="input-group">
                        <label data-i18n="label_car_type">üöò V√©hicule</label>
                        <select id="car-type-select" class="select-compact" onchange="calcTransport()">
                            <option value="car_thermal" data-i18n="opt_thermal">‚õΩ Thermique</option>
                            <option value="car_hybrid" data-i18n="opt_hybrid">üîã Hybride</option>
                            <option value="car_electric" data-i18n="opt_electric">‚ö° √âlectrique</option>
                        </select>
                    </div>
                    <div class="input-group"><label>üöó Voiture (km)</label><input type="number" id="inp-car" class="input-bare" placeholder="0" oninput="calcTransport()"></div>
                    <div class="input-group"><label>üöå Public (km)</label><input type="number" id="inp-public" class="input-bare" placeholder="0" oninput="calcTransport()"></div>
                    <div class="input-group"><label>‚úàÔ∏è Avion (km)</label><input type="number" id="inp-plane" class="input-bare" placeholder="0" oninput="calcTransport()"></div>
                    <div class="input-group" style="border-left: 3px solid #34a853;"><label>üö∂ Marche (km)</label><input type="number" id="inp-walk" class="input-bare" placeholder="0" oninput="calcTransport()"></div>
                    <div class="input-group" style="border-left: 3px solid #34a853;"><label>üö¥ V√©lo (km)</label><input type="number" id="inp-bike" class="input-bare" placeholder="0" oninput="calcTransport()"></div>

                    
                    <div class="share-section">
                        <label>ü§ù <span data-i18n="label_share">Partager (Covoit, etc.)</span></label>
                        <div class="share-grid">
                             <div class="share-opt" onclick="initShareProcess('transport', 0.10, this)">10%</div>
                          <div class="share-opt" onclick="initShareProcess('transport', 0.15, this)">15%</div>
                            <div class="share-opt" onclick="initShareProcess('transport', 0.25, this)">25%</div>
                             <div class="share-opt" onclick="initShareProcess('transport', 0.40, this)">40%</div>
                            <div class="share-opt" onclick="initShareProcess('transport', 0.50, this)">50%</div>
                            <div class="share-opt" onclick="initShareProcess('transport', 0.75, this)">75%</div>
                         <div class="share-opt" onclick="initShareProcess('transport', 0.90, this)">90%</div>
                        </div>
                        <div id="share-finalize-transport" class="share-finalize">
                            <label style="display:block; margin-bottom:4px;" data-i18n="with_whom">Avec qui ?</label>
                            <select id="share-friend-select-transport" class="input-bare" style="font-size:0.8rem; background:white; border:1px solid #ddd; padding:5px; border-radius:8px; margin-bottom:5px;">
                                <option value="" data-i18n="choose_friend">Choisir un ami...</option>
                            </select>
                            <div style="display:flex; gap:5px;">
                                <button class="btn btn-secondary" style="flex:1; padding:6px; margin-top:0;" onclick="cancelShare('transport')" data-i18n="cancel">Annuler</button>
                                <button class="btn btn-primary" style="flex:1; padding:6px; margin-top:0;" onclick="confirmShare('transport')" data-i18n="send">Envoyer</button>
                            </div>
                        </div>
                        <div id="share-status-transport" style="font-size:0.75rem; color:var(--col-trans); text-align:center; display:none; margin-top:5px;"><span data-i18n="share_active">Partage actif</span> (<span id="share-val-transport">0</span>%)</div>
                    </div>
                </div>
            </div>
            <div id="sub-trans-route" class="card hidden">
                <h3 data-i18n="calc_distance_title">Calculateur</h3>
                <div class="input-group">
                    <label>üö¶ Mode</label>
                    <select id="route-mode" class="select-compact">
                        <option value="car" data-i18n="mode_car">üöó Voiture</option>
                        <option value="public" data-i18n="mode_public">üöå Public</option>
                        <option value="plane" data-i18n="mode_plane">‚úàÔ∏è Avion</option>
                        <option value="walk" data-i18n="mode_walk">üö∂ Marche</option> 
                        <option value="bike" data-i18n="mode_bike">üö¥ V√©lo</option>
                    </select>
                </div>
                <div class="input-group">
                    <label data-i18n="label_start">üö© D√©part</label>
                    <input type="text" id="route-start" class="input-bare" autocomplete="off" placeholder="Ex: Paris" onkeyup="handleAddressInput('route-start', 'suggestions-start')">
                    <div id="suggestions-start" class="suggestions-list"></div>
                </div>
                <div class="input-group">
                    <label data-i18n="label_end">üèÅ Arriv√©e</label>
                    <input type="text" id="route-end" class="input-bare" autocomplete="off" placeholder="Ex: Lyon" onkeyup="handleAddressInput('route-end', 'suggestions-end')">
                    <div id="suggestions-end" class="suggestions-list"></div>
                </div>
                 <div class="input-group"><label data-i18n="label_freq">Jours/semaine</label><input type="number" id="route-days" class="input-bare" placeholder="1"></div>
                <button class="btn btn-secondary" onclick="calculateRoute()" data-i18n="btn_calc">Calculer</button>
                <div id="route-res" class="hidden" style="margin-top:10px;"><span data-i18n="resultat">R√©sultat :</span> <b id="route-km-val">0</b> km <button onclick="applyRouteKm()" class="btn btn-primary" style="margin-top:5px;" data-i18n="btn_apply">Appliquer</button></div>
            </div>
        </div>

        <div id="view-digital" class="hidden">
            <div class="tab-impact-header">
                <span class="tab-impact-val" id="header-val-digital" style="color:var(--col-digi)">0.0</span> kg CO‚ÇÇe
                <span class="tab-impact-week-label" id="label-week-digital">Total Semaine</span>
            </div>
            <div class="card">
                <div id="week-nav-digital" class="week-nav-container"></div>
                <h3 data-i18n="usage_num">Usage Num√©rique Hebdo</h3>
                <div class="input-group"><label data-i18n="label_wifi">üì∂ Wifi (Go)</label><input type="number" id="inp-wifi" class="input-bare" placeholder="0" oninput="calcDigital()"></div>
                <div class="input-group"><label data-i18n="label_mobile">üì° 4G/5G (Go)</label><input type="number" id="inp-mobile" class="input-bare" placeholder="0" oninput="calcDigital()"></div>
                <button onclick="showDataHelp()" class="btn-help-data" data-i18n="btn_help_data">
    üîç O√π trouver ma consommation ?
</button>

            
                
                <div class="share-section">
                    <label>ü§ù <span data-i18n="label_share">Partager (Foyer)</span></label>
                    <div class="share-grid">
                          <div class="share-opt" onclick="initShareProcess('digital', 0.10, this)">10%</div>
                          <div class="share-opt" onclick="initShareProcess('digital', 0.15, this)">15%</div>
                            <div class="share-opt" onclick="initShareProcess('digital', 0.25, this)">25%</div>
                             <div class="share-opt" onclick="initShareProcess('digital', 0.40, this)">40%</div>
                            <div class="share-opt" onclick="initShareProcess('digital', 0.50, this)">50%</div>
                            <div class="share-opt" onclick="initShareProcess('digital', 0.75, this)">75%</div>
                         <div class="share-opt" onclick="initShareProcess('digital', 0.90, this)">90%</div>
                    </div>
                    <div id="share-finalize-digital" class="share-finalize">
                        <label style="display:block; margin-bottom:4px;" data-i18n="with_whom">Avec qui ?</label>
                        <select id="share-friend-select-digital" class="input-bare" style="font-size:0.8rem; background:white; border:1px solid #ddd; padding:5px; border-radius:8px; margin-bottom:5px;">
                            <option value="" data-i18n="choose_friend">Choisir un ami...</option>
                        </select>
                        <div style="display:flex; gap:5px;">
                            <button class="btn btn-secondary" style="flex:1; padding:6px; margin-top:0;" onclick="cancelShare('digital')" data-i18n="cancel">Annuler</button>
                            <button class="btn btn-primary" style="flex:1; padding:6px; margin-top:0;" onclick="confirmShare('digital')" data-i18n="send">Envoyer</button>
                        </div>
                    </div>
                    <div id="share-status-digital" style="font-size:0.75rem; color:var(--col-digi); text-align:center; display:none; margin-top:5px;"><span data-i18n="share_active">Partage actif</span> (<span id="share-val-digital">0</span>%)</div>
                </div>
            </div>
        </div>

        <div id="view-elec" class="hidden">
            <div class="tab-impact-header">
                <span class="tab-impact-val" id="header-val-elec" style="color:var(--col-elec)">0.0</span> kg CO‚ÇÇe
                <span class="tab-impact-week-label" id="label-week-elec">Total Semaine</span>
            </div>
            <div class="card">
                <div id="week-nav-elec" class="week-nav-container"></div>
                <h3 data-i18n="elec_foyer">√âlectricit√© Hebdo</h3>
                <div class="input-group"><label data-i18n="label_kwh">‚ö° Conso (kWh)</label><input type="number" id="inp-kwh" class="input-bare" placeholder="0" oninput="calcElec()"></div>
                
                <div class="share-section">
                    <label>ü§ù <span data-i18n="label_share">Partager (Coloc/Famille)</span></label>
                    <div class="share-grid">
                         <div class="share-opt" onclick="initShareProcess('elec', 0.10, this)">10%</div>
                          <div class="share-opt" onclick="initShareProcess('elec', 0.15, this)">15%</div>
                            <div class="share-opt" onclick="initShareProcess('elec', 0.25, this)">25%</div>
                             <div class="share-opt" onclick="initShareProcess('elec', 0.40, this)">40%</div>
                            <div class="share-opt" onclick="initShareProcess('elec', 0.50, this)">50%</div>
                            <div class="share-opt" onclick="initShareProcess('elec', 0.75, this)">75%</div>
                         <div class="share-opt" onclick="initShareProcess('elec', 0.90, this)">90%</div>
                    </div>
                     <div id="share-finalize-elec" class="share-finalize">
                        <label style="display:block; margin-bottom:4px;" data-i18n="with_whom">Avec qui ?</label>
                        <select id="share-friend-select-elec" class="input-bare" style="font-size:0.8rem; background:white; border:1px solid #ddd; padding:5px; border-radius:8px; margin-bottom:5px;">
                            <option value="" data-i18n="choose_friend">Choisir un ami...</option>
                        </select>
                        <div style="display:flex; gap:5px;">
                            <button class="btn btn-secondary" style="flex:1; padding:6px; margin-top:0;" onclick="cancelShare('elec')" data-i18n="cancel">Annuler</button>
                            <button class="btn btn-primary" style="flex:1; padding:6px; margin-top:0;" onclick="confirmShare('elec')" data-i18n="send">Envoyer</button>
                        </div>
                    </div>
                    <div id="share-status-elec" style="font-size:0.75rem; color:var(--col-elec); text-align:center; display:none; margin-top:5px;"><span data-i18n="share_active">Partage actif</span> (<span id="share-val-elec">0</span>%)</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="main-tabs">
        <button class="tab-item active" onclick="nav('home', this)"><span class="tab-icon">‚ú®</span><span data-i18n="nav_home">Accueil</span></button>
        <button class="tab-item" onclick="nav('courses', this)"><span class="tab-icon">üõí</span><span data-i18n="nav_shop">Achats</span></button>
        <button class="tab-item" onclick="nav('transport', this)"><span class="tab-icon">üöó</span><span data-i18n="nav_travel">Trajet</span></button>
        <button class="tab-item" onclick="nav('digital', this)"><span class="tab-icon">üì±</span><span data-i18n="nav_web">Web</span></button>
        <button class="tab-item" onclick="nav('elec', this)"><span class="tab-icon">‚ö°</span><span data-i18n="nav_elec">√âlec</span></button>
    </div>

    <div id="auth-modal" class="modal-overlay">
        <div class="modal-card">
            
            <div style="margin-bottom: 20px;">
                <label style="display:block; margin-bottom:5px;" data-i18n="lang_label">Langue / Language</label>
                <select id="lang-selector" class="select-compact" onchange="changeLanguage(this.value)" style="width: 100%;">
                    <option value="fr">üá´üá∑ Fran√ßais</option>
                    <option value="en">üá¨üáß English</option>
                    <option value="es">üá™üá∏ Espa√±ol</option>
                    <option value="zh">üáπüáº ÁπÅÈ´î‰∏≠Êñá</option>
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display:block; margin-bottom:5px;" data-i18n="country_label">Pays / Country</label>
                <div class="country-search-box">
                    <input type="text" id="country-search" class="input-bare" style="background:#f0f4f9; padding:10px; border-radius:12px;" placeholder="..." onkeyup="filterCountries()">
                    <div id="country-list-container" class="country-list"></div>
                </div>
                <div style="font-size:0.8rem; color:var(--text-sub);"><span data-i18n="current_val">Actuel :</span> <strong id="current-country-display">France</strong></div>
            </div>

            <div id="auth-content">
                <div class="auth-toggle">
                    <button id="btn-mode-login" class="active" onclick="setAuthMode('login')" data-i18n="connexion">Connexion</button>
                    <button id="btn-mode-register" onclick="setAuthMode('register')" data-i18n="inscription">Inscription</button>
                </div>
                
                <h2 id="auth-title" data-i18n="connexion" style="margin-top:0;">Connexion</h2>
                
                <div id="field-username" class="input-group hidden" style="border:1px solid #eee;">
                    <label data-i18n="username">üë§ Nom d'utilisateur</label>
                    <input type="text" id="auth-username" class="input-bare" placeholder="Ex: Alex2026">
                </div>
                <div class="input-group" style="border:1px solid #eee;">
                    <label data-i18n="email">‚úâÔ∏è Email</label>
                    <input type="email" id="auth-email" class="input-bare">
                </div>
                <div class="input-group" style="border:1px solid #eee;">
                    <label data-i18n="password">üîí Mot de passe</label>
                    <input type="password" id="auth-password" class="input-bare">
                </div>
                <button class="btn btn-primary" onclick="submitAuth()" data-i18n="btn_connect">Valider</button>
                
                <a class="forgot-link" onclick="resetPassword()" data-i18n="forgot_pass">Mot de passe oubli√© ?</a>
            </div>

            <div id="user-content" class="hidden" style="text-align:center;">
                <div style="font-size:3rem; margin-bottom:10px; background:var(--primary-bg); width:70px; height:70px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center;">üë§</div>
                <p><span data-i18n="connected_as">Connect√© :</span> <br><b id="user-display-name" style="font-size:1.1rem;"></b><br><span id="user-email-display" style="font-size:0.8rem; color:var(--text-sub)"></span></p>
                <button class="btn btn-secondary" onclick="logout()" style="background:#fce8e6; color:#c53030;" data-i18n="btn_logout">D√©connexion</button>
            </div>
            
            <button onclick="toggleAuthModal()" style="margin-top:20px; background:none; border:none; color:var(--text-sub); width:100%; cursor:pointer; font-size:0.9rem;" data-i18n="btn_close">Fermer</button>
        </div>
    </div>

<script>
    // --- DATA & GLOBALS ---
    const API_BASE_URL = "http://127.0.0.1:5000"; 
    const COUNTRIES = [
        { name: "France", tz: "Europe/Paris" }, { name: "USA (NY)", tz: "America/New_York" },
        { name: "UK", tz: "Europe/London" }, { name: "Espa√±a", tz: "Europe/Madrid" },
        { name: "China", tz: "Asia/Shanghai" }, { name: "Japan", tz: "Asia/Tokyo" },
        { name: "Brazil", tz: "America/Sao_Paulo" }, { name: "Australia", tz: "Australia/Sydney" },
        { name: "Canada", tz: "America/Toronto" }, { name: "Russia", tz: "Europe/Moscow" },
        { name: "Maroc", tz: "Africa/Casablanca" }, { name: "Alg√©rie", tz: "Africa/Algiers" },
        { name: "Taiwan", tz: "Asia/Taipei" }
    ];
    
    // GESTION SESSION VIA LOCALSTORAGE
    let currentUser = JSON.parse(localStorage.getItem('user_session'));
    
    let friends = JSON.parse(localStorage.getItem('impact_friends')) || [];
    let currentLang = 'fr';
    let currentCountry = JSON.parse(localStorage.getItem('impact_country')) || { name: "France", tz: "Europe/Paris" };
    
    const MAX_COINS = 1000; 
    let activeSplits = JSON.parse(localStorage.getItem('impact_splits')) || { courses:0, transport:0, digital:0, elec:0 };

    const APP_START_DATE_STR = '2026-01-05T00:00:00';
    const APP_START_EPOCH = new Date(APP_START_DATE_STR).getTime();
    
    let currentSelectedWeekId = null;

    let impactDB = { courses:{}, transport:{}, digital:{}, elec:{} };

    // --- TRADUCTION COMPL√àTE ---
    const TRANSLATIONS = {
        fr: {
            bilan_label: "BILAN CO‚ÇÇe (Semaine)", coins_label: "PI√àCES", friends_share: "Amis & Partage",
            cat_courses: "COURSES", cat_transport: "TRANSPORT", cat_digital: "DIGITAL", cat_elec: "√âLEC",
            cat_courses_short: "Courses", cat_trans_short: "Transp.", cat_digi_short: "Digi", cat_elec_short: "√âlec",
            label_evolution: "√âvolution (7 Semaines)", my_friends: "Mes Amis", no_friends: "Aucun ami ajout√©.",
            coin_val: "Valorisation Pi√®ces", coin_desc: "Les pi√®ces se valorisent chaque semaine.", historique_title: "Historique",
            tab_budget: "Budget", tab_scanner: "Scanner", budget_mensuel: "Budget Hebdo", label_regime: "R√©gime",
            opt_normal: "Omnivore", opt_vege: "V√©g√©tarien", opt_vegan: "V√©g√©talien", label_food: "Alimentation (‚Ç¨)", label_misc: "Autres (‚Ç¨)",
            label_share: "Partager", with_whom: "Avec qui ?", choose_friend: "Choisir un ami...", cancel: "Annuler", send: "Envoyer", share_active: "Partage actif",
            btn_scan: "üì∑ Scanner", product: "Produit", tab_saisie: "Saisie", tab_itineraire: "Itin√©raire", transport_mensuel: "Transport Hebdo",
            label_car_type: "V√©hicule", opt_thermal: "Thermique", opt_hybrid: "Hybride", opt_electric: "√âlectrique",
            calc_distance_title: "Calculateur", label_start: "D√©part", label_end: "Arriv√©e", label_freq: "Jours/sem", btn_calc: "Calculer", resultat: "R√©sultat :", btn_apply: "Appliquer",
            mode_car: "üöó Voiture", mode_public: "üöå Public", mode_plane: "‚úàÔ∏è Avion", mode_walk: "üö∂ Marche", mode_bike: "üö¥ V√©lo",
            usage_num: "Usage Num√©rique Hebdo", label_wifi: "Wifi (Go)", label_mobile: "4G/5G (Go)", btn_help_data: "üîç O√π trouver ma consommation ?",
            elec_foyer: "√âlectricit√© Hebdo", label_kwh: "Conso (kWh)", nav_home: "Accueil", nav_shop: "Achats", nav_travel: "Trajet", nav_web: "Web", nav_elec: "√âlec",
            lang_label: "Langue / Language", country_label: "Pays / Country", current_val: "Actuel :", connexion: "Connexion", inscription: "Inscription",
            username: "üë§ Nom d'utilisateur", email: "‚úâÔ∏è Email", password: "üîí Mot de passe", btn_connect: "Valider", forgot_pass: "Mot de passe oubli√© ?",
            connected_as: "Connect√© :", btn_logout: "D√©connexion", btn_close: "Fermer", repartition: "R√©part.", txt_share_req: "veut partager", btn_accept: "Accepter", btn_reject: "Rejeter",
            got_it: "J'ai compris", data_help_title: "Suivi des donn√©es"
        },
        en: {
            bilan_label: "CO‚ÇÇe REPORT (Week)", coins_label: "COINS", friends_share: "Friends & Share",
            cat_courses: "SHOP", cat_transport: "TRAVEL", cat_digital: "DIGITAL", cat_elec: "POWER",
            cat_courses_short: "Shop", cat_trans_short: "Travel", cat_digi_short: "Digi", cat_elec_short: "Power",
            label_evolution: "History (7 Weeks)", my_friends: "My Friends", no_friends: "No friends added.",
            coin_val: "Coin Value", coin_desc: "Coins gain value every week.", historique_title: "History",
            tab_budget: "Budget", tab_scanner: "Scanner", budget_mensuel: "Weekly Budget", label_regime: "Diet",
            opt_normal: "Omnivore", opt_vege: "Vegetarian", opt_vegan: "Vegan", label_food: "Food (‚Ç¨)", label_misc: "Misc (‚Ç¨)",
            label_share: "Share", with_whom: "With whom?", choose_friend: "Pick a friend...", cancel: "Cancel", send: "Send", share_active: "Active Share",
            btn_scan: "üì∑ Scanner", product: "Product", tab_saisie: "Input", tab_itineraire: "Route", transport_mensuel: "Weekly Transport",
            label_car_type: "Vehicle", opt_thermal: "Gas", opt_hybrid: "Hybrid", opt_electric: "Electric",
            calc_distance_title: "Calculator", label_start: "Start", label_end: "End", label_freq: "Days/wk", btn_calc: "Calculate", resultat: "Result:", btn_apply: "Apply",
            mode_car: "üöó Car", mode_public: "üöå Public", mode_plane: "‚úàÔ∏è Plane", mode_walk: "üö∂ Walk", mode_bike: "üö¥ Bike",
            usage_num: "Digital Weekly", label_wifi: "Wifi (GB)", label_mobile: "Mobile (GB)", btn_help_data: "üîç Where to find my data?",
            elec_foyer: "Power Weekly", label_kwh: "Usage (kWh)", nav_home: "Home", nav_shop: "Shop", nav_travel: "Travel", nav_web: "Web", nav_elec: "Power",
            lang_label: "Language", country_label: "Country", current_val: "Current:", connexion: "Login", inscription: "Register",
            username: "üë§ Username", email: "‚úâÔ∏è Email", password: "üîí Password", btn_connect: "Submit", forgot_pass: "Forgot password?",
            connected_as: "Logged in:", btn_logout: "Logout", btn_close: "Close", repartition: "Split", txt_share_req: "wants to share", btn_accept: "Accept", btn_reject: "Reject",
            got_it: "Got it", data_help_title: "Data Tracking"
        },
        es: {
            bilan_label: "BALANCE CO‚ÇÇe (Semana)", coins_label: "MONEDAS", friends_share: "Amigos y Compartir",
            cat_courses: "COMPRAS", cat_transport: "VIAJE", cat_digital: "DIGITAL", cat_elec: "ELEC",
            cat_courses_short: "Comp.", cat_trans_short: "Viaje", cat_digi_short: "Digi", cat_elec_short: "Elec",
            label_evolution: "Evoluci√≥n (7 Semanas)", my_friends: "Mis Amigos", no_friends: "Ning√∫n amigo a√±adido.",
            coin_val: "Valoraci√≥n Monedas", coin_desc: "Las monedas ganan valor cada semana.", historique_title: "Historial",
            tab_budget: "Presupuesto", tab_scanner: "Esc√°ner", budget_mensuel: "Presupuesto Semanal", label_regime: "Dieta",
            opt_normal: "Omn√≠voro", opt_vege: "Vegetariano", opt_vegan: "Vegano", label_food: "Comida (‚Ç¨)", label_misc: "Ocio (‚Ç¨)",
            label_share: "Compartir", with_whom: "¬øCon qui√©n?", choose_friend: "Elegir amigo...", cancel: "Cancelar", send: "Enviar", share_active: "Compartir activo",
            btn_scan: "üì∑ Escanear", product: "Producto", tab_saisie: "Entrada", tab_itineraire: "Ruta", transport_mensuel: "Transporte Semanal",
            label_car_type: "Veh√≠culo", opt_thermal: "T√©rmico", opt_hybrid: "H√≠brido", opt_electric: "El√©ctrico",
            calc_distance_title: "Calculadora", label_start: "Inicio", label_end: "Fin", label_freq: "D√≠as/sem", btn_calc: "Calcular", resultat: "Resultado:", btn_apply: "Aplicar",
            mode_car: "üöó Coche", mode_public: "üöå P√∫blico", mode_plane: "‚úàÔ∏è Avi√≥n", mode_walk: "üö∂ Pie", mode_bike: "üö¥ Bici",
            usage_num: "Uso Digital Semanal", label_wifi: "Wifi (GB)", label_mobile: "M√≥vil (GB)", btn_help_data: "üîç ¬øD√≥nde encontrar mis datos?",
            elec_foyer: "Electricidad Semanal", label_kwh: "Consumo (kWh)", nav_home: "Inicio", nav_shop: "Compras", nav_travel: "Viaje", nav_web: "Web", nav_elec: "Elec",
            lang_label: "Idioma", country_label: "Pa√≠s", current_val: "Actual:", connexion: "Conexi√≥n", inscription: "Registro",
            username: "üë§ Usuario", email: "‚úâÔ∏è Email", password: "üîí Clave", btn_connect: "Validar", forgot_pass: "¬øOlvidaste clave?",
            connected_as: "Conectado:", btn_logout: "Salir", btn_close: "Cerrar", repartition: "Repart.", txt_share_req: "quiere compartir", btn_accept: "Aceptar", btn_reject: "Rechazar",
            got_it: "Entendido", data_help_title: "Seguimiento de datos"
        },
        zh: {
            bilan_label: "CO‚ÇÇe Â†±Âëä (ÈÄ±)", coins_label: "ÈáëÂπ£", friends_share: "Â•ΩÂèãËàáÂàÜ‰∫´",
            cat_courses: "Ë≥ºÁâ©", cat_transport: "‰∫§ÈÄö", cat_digital: "Êï∏Á¢º", cat_elec: "ÈõªÂäõ",
            cat_courses_short: "Ë≥ºÁâ©", cat_trans_short: "‰∫§ÈÄö", cat_digi_short: "Êï∏Á¢º", cat_elec_short: "ÈõªÂäõ",
            label_evolution: "Ë∂®Âã¢ (7 ÈÄ±)", my_friends: "ÊàëÁöÑÂ•ΩÂèã", no_friends: "Êú™Ê∑ªÂä†Â•ΩÂèã„ÄÇ",
            coin_val: "ÈáëÂπ£ÂÉπÂÄº", coin_desc: "ÈáëÂπ£ÊØèÈÄ±Â¢ûÂÄº„ÄÇ", historique_title: "Ê≠∑Âè≤Ë®òÈåÑ",
            tab_budget: "È†êÁÆó", tab_scanner: "ÊéÉÊèè", budget_mensuel: "ÊØèÈÄ±È†êÁÆó", label_regime: "È£≤È£ü",
            opt_normal: "ÈõúÈ£ü", opt_vege: "Á¥†È£ü", opt_vegan: "Á¥îÁ¥†", label_food: "È£üÂìÅ (‚Ç¨)", label_misc: "ÂÖ∂‰ªñ (‚Ç¨)",
            label_share: "ÂàÜ‰∫´", with_whom: "ËàáË™∞ÂàÜ‰∫´Ôºü", choose_friend: "ÈÅ∏ÊìáÂ•ΩÂèã...", cancel: "ÂèñÊ∂à", send: "ÁôºÈÄÅ", share_active: "Ê≠£Âú®ÂàÜ‰∫´",
            btn_scan: "üì∑ ÊéÉÊèè", product: "Áî¢ÂìÅ", tab_saisie: "Ëº∏ÂÖ•", tab_itineraire: "Ë∑ØÁ∑ö", transport_mensuel: "ÊØèÈÄ±‰∫§ÈÄö",
            label_car_type: "ËªäËºõ", opt_thermal: "ÁáÉÊ≤π", opt_hybrid: "Ê∑∑Âêà", opt_electric: "ÈõªÂãï",
            calc_distance_title: "Ë®àÁÆóÂô®", label_start: "Ëµ∑Èªû", label_end: "ÁµÇÈªû", label_freq: "Â§©/ÈÄ±", btn_calc: "Ë®àÁÆó", resultat: "ÁµêÊûú:", btn_apply: "ÊáâÁî®",
            mode_car: "üöó Ê±ΩËªä", mode_public: "üöå ÂÖ¨‰∫§", mode_plane: "‚úàÔ∏è È£õÊ©ü", mode_walk: "üö∂ Ê≠•Ë°å", mode_bike: "üö¥ Ëá™Ë°åËªä",
            usage_num: "ÊØèÈÄ±Êï∏Á¢º‰ΩøÁî®", label_wifi: "Wifi (GB)", label_mobile: "ÁßªÂãïÊï∏Êìö (GB)", btn_help_data: "üîç Âì™Ë£°ÂèØ‰ª•ÊâæÂà∞ÊàëÁöÑÊï∏ÊìöÔºü",
            elec_foyer: "ÊØèÈÄ±ÈõªÂäõ", label_kwh: "Áî®Èáè (kWh)", nav_home: "È¶ñÈ†Å", nav_shop: "Ë≥ºÁâ©", nav_travel: "‰∫§ÈÄö", nav_web: "Á∂≤Áµ°", nav_elec: "ÈõªÂäõ",
            lang_label: "Ë™ûË®Ä", country_label: "ÂúãÂÆ∂", current_val: "Áï∂Ââç:", connexion: "ÁôªÈåÑ", inscription: "Ë®ªÂÜä",
            username: "üë§ Áî®Êà∂Âêç", email: "‚úâÔ∏è ÈÉµÁÆ±", password: "üîí ÂØÜÁ¢º", btn_connect: "Êèê‰∫§", forgot_pass: "ÂøòË®òÂØÜÁ¢ºÔºü",
            connected_as: "Â∑≤ÁôªÈåÑ:", btn_logout: "ÁôªÂá∫", btn_close: "ÈóúÈñâ", repartition: "ÂàÜ‰Ωà", txt_share_req: "ÊÉ≥Ë¶ÅÂàÜ‰∫´", btn_accept: "Êé•Âèó", btn_reject: "ÊãíÁµï",
            got_it: "ÊòéÁôΩ‰∫Ü", data_help_title: "Êï∏ÊìöËøΩË∏™"
        }
    };

    const FACTORS = { elec: 0.045, car_thermal: 0.218, car_electric: 0.103, car_hybrid: 0.145, public: 0.025, plane: 0.180, wifi: 0.018, mobile: 0.050, walk: 0, bike: 0 };
    const BUDGET_RATIOS = { normal: { food: 0.75, misc: 0.35 }, vegetarien: { food: 0.45, misc: 0.35 }, vegan: { food: 0.30, misc: 0.35 } };

    // --- INFINITE WEEK GENERATION LOGIC ---
    function getWeeks() {
        const weeks = [];
        const now = new Date();
        let current = new Date(APP_START_EPOCH);
        let safety = 0;
        let futureReached = false;

        while (safety < 1000 && !futureReached) {
            const end = new Date(current);
            end.setDate(end.getDate() + 6);
            const startStr = current.toLocaleDateString(currentLang, {day: 'numeric', month: 'short'});
            const endStr = end.toLocaleDateString(currentLang, {day: 'numeric', month: 'short'});
            
            weeks.push({
                id: current.getTime().toString(),
                label: `${startStr} - ${endStr}`,
                startDate: new Date(current),
                endDate: new Date(end)
            });

            if (current > now) futureReached = true;
            current.setDate(current.getDate() + 7);
            safety++;
        }
        return weeks; 
    }

    function renderWeekNav(cat) {
        const container = document.getElementById(`week-nav-${cat}`);
        if(!container) return;
        container.innerHTML = "";
        
        const weeks = getWeeks();
        if(weeks.length === 0) return;

        if(!currentSelectedWeekId || !weeks.find(w=>w.id === currentSelectedWeekId)) {
            currentSelectedWeekId = weeks[weeks.length-1].id;
        }

        weeks.forEach(w => {
            const chip = document.createElement('div');
            chip.className = `week-chip ${w.id === currentSelectedWeekId ? 'active' : ''}`;
            chip.textContent = w.label;
            chip.onclick = () => {
                currentSelectedWeekId = w.id;
                ['courses','transport','digital','elec'].forEach(c => renderWeekNav(c));
                loadAllWeekData(w.id);
            };
            container.appendChild(chip);
        });

        setTimeout(() => {
            const activeEl = container.querySelector('.active');
            if(activeEl) container.scrollTo({ left: activeEl.offsetLeft - 50, behavior: 'smooth' });
        }, 100);

        updateHeaderTotal(cat);
    }
    
    function getWeeklyTotal(cat, weekId) {
        if(!weekId) weekId = currentSelectedWeekId;
        if(!weekId) return 0;
        if(impactDB[cat] && impactDB[cat][weekId]) {
            return impactDB[cat][weekId].total * (1 - (activeSplits[cat] || 0));
        }
        return 0;
    }

    function updateHeaderTotal(cat) {
        const total = getWeeklyTotal(cat, currentSelectedWeekId);
        const el = document.getElementById(`header-val-${cat}`);
        if(el) el.textContent = total.toFixed(1);
        
        const weeks = getWeeks();
        const selectedWeek = weeks.find(w => w.id === currentSelectedWeekId);
        if(selectedWeek) {
            const lbl = document.getElementById(`label-week-${cat}`);
            // Traduction dynamique pour "Total Semaine" ? On garde simple "Total [Date]"
            if(lbl) lbl.textContent = "Total " + selectedWeek.label;
            if(cat === 'courses') document.getElementById('display-current-week').textContent = selectedWeek.label.toUpperCase();
        }
    }

    // --- DATA LOADING & SAVING (USER SPECIFIC) ---
    function getUserDBKey() {
        if (!currentUser) return null;
        return `user_${currentUser.id}_impact_db_v3`;
    }

    function loadAllWeekData(weekId) {
        if (!currentUser) {
            impactDB = { courses:{}, transport:{}, digital:{}, elec:{} };
        } else {
            const key = getUserDBKey();
            impactDB = JSON.parse(localStorage.getItem(key)) || { courses:{}, transport:{}, digital:{}, elec:{} };
        }

        loadWeekData('courses', weekId);
        loadWeekData('transport', weekId);
        loadWeekData('digital', weekId);
        loadWeekData('elec', weekId);
        updateDashboard();
    }

    function loadWeekData(cat, weekId) {
        const record = (impactDB[cat] && impactDB[cat][weekId]) ? impactDB[cat][weekId] : null;
        
        if (cat === 'courses') {
            document.getElementById('regime-select').value = record?.inputs?.regime || 'normal';
            document.getElementById('inp-food').value = record?.inputs?.food || '';
            document.getElementById('inp-misc').value = record?.inputs?.misc || '';
        } else if (cat === 'transport') {
            document.getElementById('car-type-select').value = record?.inputs?.carType || 'car_thermal';
            document.getElementById('inp-car').value = record?.inputs?.car || '';
            document.getElementById('inp-public').value = record?.inputs?.pub || '';
            document.getElementById('inp-plane').value = record?.inputs?.plane || '';
            document.getElementById('inp-walk').value = record?.inputs?.walk || '';
            document.getElementById('inp-bike').value = record?.inputs?.bike || '';
        } else if (cat === 'digital') {
            document.getElementById('inp-wifi').value = record?.inputs?.wifi || '';
            document.getElementById('inp-mobile').value = record?.inputs?.mobile || '';
        } else if (cat === 'elec') {
            document.getElementById('inp-kwh').value = record?.inputs?.kwh || '';
        }
        updateHeaderTotal(cat);
    }

    function saveWeekData(cat, total, inputs) {
        if (!currentSelectedWeekId) return;
        if (!currentUser) return; 

        if (!impactDB[cat]) impactDB[cat] = {};

        impactDB[cat][currentSelectedWeekId] = {
            total: total,
            inputs: inputs,
            timestamp: Date.now()
        };
        
        const key = getUserDBKey();
        if (key) localStorage.setItem(key, JSON.stringify(impactDB));
        
        updateHeaderTotal(cat);
    }

    // --- UTILS ---
    function changeLanguage(lang) {
        currentLang = lang;
        localStorage.setItem('selected_lang', lang);
        updateText();
        updateDashboard();
        renderArchives();
        ['courses','transport','digital','elec'].forEach(c => renderWeekNav(c));
    }
    
    function updateText() {
        const t = TRANSLATIONS[currentLang];
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (t[key]) el.textContent = t[key];
        });
        generateAdvice();
    }

    // --- NAVIGATION & TABS ---
    function nav(viewId, btn) {
        if (!btn && viewId) { const b=document.querySelector(`.tab-item[onclick="nav('${viewId}', this)"]`); if(b)nav(viewId,b); return; }
        document.querySelectorAll('.tab-item').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        ['home','courses','transport','digital','elec'].forEach(v => document.getElementById('view-'+v).classList.add('hidden'));
        document.getElementById('view-'+viewId).classList.remove('hidden');
        
        if(viewId === 'home') {
            updateDashboard();
        } else {
            renderWeekNav(viewId);
            loadWeekData(viewId, currentSelectedWeekId);
        }
    }
    
    function resetToHomeGrid() {
        nav('home', document.querySelector('.tab-item:first-child'));
        goToSlide('slide-grid');
    }

    function switchCourseSub(sub, btn) {
        document.querySelectorAll('#view-courses .sub-nav button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        ['budget','scanner'].forEach(s => document.getElementById('sub-'+s).classList.add('hidden'));
        document.getElementById('sub-' + sub).classList.remove('hidden');
    }
    
    function switchTransSub(sub) {
        const btnCalc = document.getElementById('btn-trans-calc');
        const btnRoute = document.getElementById('btn-trans-route');
        ['direct','route'].forEach(s => document.getElementById('sub-trans-'+s).classList.add('hidden'));
        document.getElementById('sub-trans-' + sub).classList.remove('hidden');
        if(sub==='direct') { btnCalc.classList.add('active'); btnRoute.classList.remove('active'); }
        else { btnRoute.classList.add('active'); btnCalc.classList.remove('active'); }
    }

    // --- CAROUSEL ---
    function updateDots() {
        const c = document.getElementById('home-carousel');
        const idx = Math.round(c.scrollLeft / c.offsetWidth);
        [0,1,2,3,4].forEach(i => document.getElementById('dot-'+i).classList.toggle('active', i===idx));
    }
    
    function goToSlide(id) {
        const c = document.getElementById('home-carousel');
        const target = document.getElementById(id);
        if(target) c.scrollTo({ left: target.offsetLeft, behavior: 'smooth' });
    }

    // --- DASHBOARD CORE ---
    function updateDashboard() {
        if (!currentUser) {
            document.getElementById('global-score').textContent = "0.0";
            document.getElementById('global-coins').textContent = "0";
            
            const emptyVal = "0.0 <span style='font-size: 0.75em; opacity: 0.6; font-weight: normal;'>kgCO2e</span>";
            document.getElementById('home-val-courses').innerHTML = emptyVal;
            document.getElementById('home-val-transport').innerHTML = emptyVal;
            document.getElementById('home-val-digital').innerHTML = emptyVal;
            document.getElementById('home-val-elec').innerHTML = emptyVal;

            document.getElementById('dashboard-donut').style.background = "#eff1f4";
            document.getElementById('archive-list').innerHTML = "<div style='color:#777; font-size:0.8rem; padding:10px;'>Veuillez vous connecter.</div>";
            document.getElementById('evo-svg').innerHTML = ""; 
            return;
        }

        const mCourses = getWeeklyTotal('courses', currentSelectedWeekId);
        const mTrans = getWeeklyTotal('transport', currentSelectedWeekId);
        const mDigi = getWeeklyTotal('digital', currentSelectedWeekId);
        const mElec = getWeeklyTotal('elec', currentSelectedWeekId);
        
        const total = mCourses + mTrans + mDigi + mElec;

        document.getElementById('global-score').textContent = total.toFixed(1);
        
        const coins = MAX_COINS - (total * 3);
        const coinEl = document.getElementById('global-coins');
        if (coinEl) {
            coinEl.textContent = Math.round(coins);
            coins < 0 ? coinEl.classList.add('negative') : coinEl.classList.remove('negative');
        }

        const unitTag = " <span style='font-size: 0.75em; opacity: 0.6; font-weight: normal;'>kgCO2e</span>";

        document.getElementById('home-val-courses').innerHTML = mCourses.toFixed(1) + unitTag;
        document.getElementById('home-val-transport').innerHTML = mTrans.toFixed(1) + unitTag;
        document.getElementById('home-val-digital').innerHTML = mDigi.toFixed(1) + unitTag;
        document.getElementById('home-val-elec').innerHTML = mElec.toFixed(1) + unitTag;

        renderGraph(total);
        updateDonut(mCourses, mTrans, mDigi, mElec, total);
    }

    function renderGraph(currentVal) {
        const svg = document.getElementById('evo-svg');
        svg.innerHTML = ''; 
        if (!currentUser) return;

        const weeks = getWeeks();
        const displayWeeks = weeks.slice(-7);
        
        const labels = [];
        const values = [];
        
        displayWeeks.forEach(w => {
            const startStr = w.startDate.toLocaleDateString(currentLang, {day:'2-digit', month:'2-digit'});
            labels.push(startStr);
            let wTotal = 0;
            if(w.id === currentSelectedWeekId) wTotal = currentVal; 
            else {
                wTotal += (impactDB['courses']?.[w.id]?.total||0);
                wTotal += (impactDB['transport']?.[w.id]?.total||0);
                wTotal += (impactDB['digital']?.[w.id]?.total||0);
                wTotal += (impactDB['elec']?.[w.id]?.total||0);
            }
            values.push(wTotal);
        });
        
        while(labels.length < 7) { labels.unshift("-"); values.unshift(0); }

        const width = 300, height = 120, padX = 20, padY = 20;
        const usefulH = height - padY * 2;
        const stepX = (width - padX * 2) / 6;
        const maxVal = Math.max(100, Math.max(...values) * 1.2);
        let pathD = "";
        
        values.forEach((val, i) => {
            const x = padX + i * stepX;
            const y = height - padY - ((val / maxVal) * usefulH);
            if (i === 0) pathD += `M ${x},${y} `; else pathD += `L ${x},${y} `;
            const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            circle.setAttribute("cx", x); circle.setAttribute("cy", y);
            circle.setAttribute("r", (labels[i] === "-") ? 0 : 3);
            circle.setAttribute("fill", i === 6 ? "var(--primary)" : "#ddd");
            svg.appendChild(circle);
            
            if(labels[i] !== "-") {
                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("x", x); text.setAttribute("y", height - 2);
                text.setAttribute("class", "axis-label");
                text.textContent = labels[i];
                svg.appendChild(text);
            }
        });

        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute("d", pathD);
        path.setAttribute("fill", "none");
        path.setAttribute("stroke", "var(--primary)");
        path.setAttribute("stroke-width", "2");
        path.setAttribute("stroke-linecap", "round");
        path.setAttribute("stroke-linejoin", "round");
        svg.insertBefore(path, svg.firstChild);
    }
    
    function updateDonut(c, t, d, e, total) {
        if(total === 0) { document.getElementById('dashboard-donut').style.background = "#eff1f4"; return; }
        const pC = (c / total) * 100, pT = (t / total) * 100, pD = (d / total) * 100;
        const degC = (pC * 3.6), degT = degC + (pT * 3.6), degD = degT + (pD * 3.6);
        
        const css = `conic-gradient(var(--col-courses) 0deg ${degC}deg, var(--col-trans) ${degC}deg ${degT}deg, var(--col-digi) ${degT}deg ${degD}deg, var(--col-elec) ${degD}deg 360deg)`;
        document.getElementById('dashboard-donut').style.background = css;
    }

    // --- ARCHIVES ---
    function renderArchives() {
        const list = document.getElementById('archive-list');
        list.innerHTML = ""; 

        if (!currentUser) {
            list.innerHTML = "<div style='color:#777; font-size:0.8rem; padding:10px;'>Connectez-vous pour voir votre historique.</div>";
            return;
        }

        const weeks = getWeeks().reverse();
        
        weeks.forEach((w, index) => {
            const chip = document.createElement('div');
            const isActive = (w.id === currentSelectedWeekId);
            chip.className = `archive-chip ${isActive ? 'active' : ''}`;
            chip.textContent = w.label + (index === 0 ? " (Actuel)" : ""); 
            chip.onclick = () => {
                document.querySelectorAll('.archive-chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                currentSelectedWeekId = w.id;
                loadAllWeekData(w.id); 
                ['courses','transport','digital','elec'].forEach(c => renderWeekNav(c));
                if(!isActive) showComparison(w.label); else clearComparison();
            };
            list.appendChild(chip);
        });
    }

    function showComparison(label) { document.getElementById('global-score-comp').textContent = `${label}`; }
    function clearComparison() { document.querySelectorAll('.comp-val').forEach(el => el.textContent = ""); }
    
    // --- FRIENDS ---
    function addFriend() {
        if(!currentUser) return alert("Connectez-vous !");
        const email = document.getElementById('new-friend-email').value;
        if(!email) return;
        const namePart = email.split('@')[0];
        const newFriend = { email: email, name: namePart.charAt(0).toUpperCase() + namePart.slice(1) };
        friends.push(newFriend);
        localStorage.setItem('impact_friends', JSON.stringify(friends));
        document.getElementById('new-friend-email').value = "";
        renderFriends();
        populateFriendSelects();
    }

    function renderFriends() {
        const list = document.getElementById('friends-list');
        list.innerHTML = "";
        if(friends.length === 0) { document.getElementById('no-friend-msg').style.display = 'block'; return; }
        document.getElementById('no-friend-msg').style.display = 'none';
        
        friends.forEach((f, idx) => {
            const div = document.createElement('div');
            div.className = 'friend-item';
            div.innerHTML = `<div class="friend-info"><span class="friend-name">${f.name}</span><span class="friend-email">${f.email}</span></div><button onclick="removeFriend(${idx})" style="color:#d93025; background:none; border:none; font-weight:700;">√ó</button>`;
            list.appendChild(div);
        });
    }

    function removeFriend(idx) {
        friends.splice(idx, 1);
        localStorage.setItem('impact_friends', JSON.stringify(friends));
        renderFriends();
        populateFriendSelects();
    }

    function populateFriendSelects() {
        const ids = ['share-friend-select-courses', 'share-friend-select-transport', 'share-friend-select-digital', 'share-friend-select-elec'];
        ids.forEach(id => {
            const sel = document.getElementById(id);
            if(sel) {
                const t = TRANSLATIONS[currentLang];
                sel.innerHTML = `<option value="">${t.choose_friend}</option>`;
                friends.forEach(f => {
                    const opt = document.createElement('option');
                    opt.value = f.email; opt.textContent = `${f.name} (${f.email})`;
                    sel.appendChild(opt);
                });
            }
        });
    }

    // --- SHARE LOGIC ---
    let pendingShareVal = 0;
    
    function initShareProcess(cat, val, el) {
        el.parentElement.querySelectorAll('.share-opt').forEach(e => e.classList.remove('active'));
        el.classList.add('active');
        document.getElementById(`share-finalize-${cat}`).style.display = 'block';
        pendingShareVal = val;
    }

    function confirmShare(cat) {
        if(!currentUser) return alert("Connectez-vous pour partager.");
        const friendEmail = document.getElementById(`share-friend-select-${cat}`).value;
        if(!friendEmail) return alert("Veuillez choisir un ami.");

        activeSplits[cat] = pendingShareVal;
        localStorage.setItem('impact_splits', JSON.stringify(activeSplits));
        
        document.getElementById(`share-finalize-${cat}`).style.display = 'none';
        const status = document.getElementById(`share-status-${cat}`);
        status.style.display = 'block'; status.querySelector('span').textContent = (pendingShareVal * 100);
        
        if(cat==='courses') calcBudget(); if(cat==='transport') calcTransport(); if(cat==='digital') calcDigital(); if(cat==='elec') calcElec();

        const invites = JSON.parse(localStorage.getItem('impact_invites')) || [];
        invites.push({ id: Date.now(), from: currentUser.email, fromName: currentUser.username || currentUser.email.split('@')[0], to: friendEmail, cat: cat, val: pendingShareVal, status: 'pending' });
        localStorage.setItem('impact_invites', JSON.stringify(invites));
        alert(`Demande envoy√©e √† ${friendEmail} !`);
    }

    function cancelShare(cat) {
        document.getElementById(`share-finalize-${cat}`).style.display = 'none';
        const grid = document.getElementById(`share-finalize-${cat}`).parentElement.querySelector('.share-grid');
        grid.querySelectorAll('.share-opt').forEach(e => e.classList.remove('active'));
    }
    
    function checkRealInvites() {
        if(!currentUser) { document.getElementById('notif-badge').classList.add('hidden'); return; }
        const invites = JSON.parse(localStorage.getItem('impact_invites')) || [];
        const myInvites = invites.filter(i => i.to === currentUser.email && i.status === 'pending');
        const stack = document.getElementById('invitation-stack');
        stack.innerHTML = "";
        
        const t = TRANSLATIONS[currentLang];

        if(myInvites.length > 0) {
            document.getElementById('notif-badge').textContent = myInvites.length;
            document.getElementById('notif-badge').classList.remove('hidden');
            myInvites.forEach(inv => {
                const div = document.createElement('div');
                div.className = 'friend-req-box';
                div.innerHTML = `<div style="font-size:0.8rem; margin-bottom:5px;"><strong>${inv.fromName}</strong> <span data-i18n="txt_share_req">${t.txt_share_req}</span> <strong>${inv.cat}</strong> (${inv.val * 100}%).</div><div class="notif-actions"><button class="btn-xs" style="background:white; color:var(--text-sub);" onclick="rejectShare(${inv.id})">${t.btn_reject}</button><button class="btn-xs" style="background:var(--primary); color:white;" onclick="acceptShare(${inv.id}, '${inv.cat}', ${inv.val})">${t.btn_accept}</button></div>`;
                stack.appendChild(div);
            });
        } else { document.getElementById('notif-badge').classList.add('hidden'); }
    }

    function acceptShare(id, cat, val) {
        let invites = JSON.parse(localStorage.getItem('impact_invites')) || [];
        invites = invites.map(i => i.id === id ? {...i, status: 'accepted'} : i);
        localStorage.setItem('impact_invites', JSON.stringify(invites));
        alert("Partage accept√© !");
        checkRealInvites();
    }
    function rejectShare(id) {
        let invites = JSON.parse(localStorage.getItem('impact_invites')) || [];
        invites = invites.map(i => i.id === id ? {...i, status: 'rejected'} : i);
        localStorage.setItem('impact_invites', JSON.stringify(invites));
        checkRealInvites();
    }

    // --- CALCULS ---
    function calcBudget() {
        const r = BUDGET_RATIOS[document.getElementById('regime-select').value];
        const f = parseFloat(document.getElementById('inp-food').value)||0;
        const m = parseFloat(document.getElementById('inp-misc').value)||0;
        let total = (f * r.food) + (m * r.misc);
        saveWeekData('courses', total, { regime: document.getElementById('regime-select').value, food:f, misc:m });
        updateDashboard();
    }

    function calcTransport() {
        const ct = document.getElementById('car-type-select').value;
        const c = parseFloat(document.getElementById('inp-car').value)||0;
        const p = parseFloat(document.getElementById('inp-public').value)||0;
        const pl = parseFloat(document.getElementById('inp-plane').value)||0;
        const walk = parseFloat(document.getElementById('inp-walk').value)||0;
        const bike = parseFloat(document.getElementById('inp-bike').value)||0;
        let total = (c*FACTORS[ct]) + (p*FACTORS.public) + (pl*FACTORS.plane) + (walk*FACTORS.walk) + (bike*FACTORS.bike);
        saveWeekData('transport', total, { carType:ct, car:c, pub:p, plane:pl, walk:walk, bike:bike });
        updateDashboard();
    }

    function calcDigital() {
        const w = parseFloat(document.getElementById('inp-wifi').value)||0;
        const m = parseFloat(document.getElementById('inp-mobile').value)||0;
        let total = (w*FACTORS.wifi) + (m*FACTORS.mobile);
        saveWeekData('digital', total, { wifi:w, mobile:m });
        updateDashboard();
    }

    function calcElec() {
        const k = parseFloat(document.getElementById('inp-kwh').value)||0;
        let total = k * FACTORS.elec;
        saveWeekData('elec', total, { kwh:k });
        updateDashboard();
    }

    // --- SCANNER & BACKEND INTEGRATION ---
    
    // Fonction unique pour traiter un code barre (Cam√©ra ou Manuel)
    async function processBarcode(barcode) {
        const resultDiv = document.getElementById('scan-result');
        const nameEl = document.getElementById('res-name');
        const co2El = document.getElementById('res-co2');
        const ecoEl = document.getElementById('res-eco');

        nameEl.textContent = "Chargement...";
        resultDiv.classList.remove('hidden');

        try {
            const response = await fetch(`${API_BASE_URL}/produit/${barcode}`);
            const data = await response.json();

            if (data.error) {
                nameEl.textContent = "Produit non trouv√©";
                co2El.textContent = "0.0";
                ecoEl.textContent = "";
            } else {
                nameEl.textContent = data.product.product_name;
                const co2 = data.lca_analysis.total_co2 || 0;
                co2El.textContent = co2.toFixed(2);
                ecoEl.textContent = `EcoScore: ${data.scores.ecoscore} | Nutri: ${data.scores.nutriscore}`;
                
                // Ajouter automatiquement au budget courant ? (Optionnel, ici on affiche juste)
                // On pourrait imaginer une logique pour ajouter ce CO2 √† une liste temporaire.
            }
        } catch (e) {
            console.error(e);
            nameEl.textContent = "Erreur connexion";
        }
    }

    // Gestion du scanner manuel
    function analyzeManual() {
        const code = document.getElementById('manual-barcode').value;
        if(code) processBarcode(code);
    }

    // Gestion de la cam√©ra
    let html5QrcodeScanner = null;

    function startCamera() {
        document.getElementById('scanner-start-ui').classList.add('hidden');
        
        html5QrcodeScanner = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        
        html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess);
    }

    function onScanSuccess(decodedText, decodedResult) {
        html5QrcodeScanner.stop().then(() => {
            html5QrcodeScanner.clear();
            document.getElementById('reader').innerHTML = ""; // Clean up
            processBarcode(decodedText);
        }).catch(err => console.error(err));
    }

    function resetScanner() {
        document.getElementById('scan-result').classList.add('hidden');
        document.getElementById('scanner-start-ui').classList.remove('hidden');
        document.getElementById('manual-barcode').value = "";
    }

    // --- AIDE DONN√âES ---
    function showDataHelp() {
        const t = TRANSLATIONS[currentLang];
        const helpContent = `
            <strong>üíª Apple (Mac) :</strong> App > Monitor > Network.<br><br>
            <strong>üì± iPhone :</strong> Settings > Cellular > Current Period.<br><br>
            <strong>ü§ñ Android :</strong> Settings > Network > Data usage.<br><br>
            <strong>ü™ü Windows :</strong> Settings > Network > Data usage.
        `;
        const modal = document.createElement('div');
        modal.style = "position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:25px; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,0.3); z-index:10000; width:85%; max-width:400px; font-family:'Google Sans', sans-serif;";
        modal.innerHTML = `
            <h3 style="margin-top:0; color:var(--primary);">${t.data_help_title}</h3>
            <p style="font-size:0.9rem; line-height:1.4; color:var(--text-sub);">${helpContent}</p>
            <button onclick="this.parentElement.remove()" style="width:100%; padding:10px; border:none; background:var(--primary-bg); color:var(--primary); border-radius:10px; cursor:pointer; font-weight:bold;">${t.got_it}</button>
        `;
        document.body.appendChild(modal);
    }

    // --- AUTHENTIFICATION ---
    function toggleAuthModal() {
        const m = document.getElementById('auth-modal');
        m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
        
        if(currentUser) {
            document.getElementById('auth-content').classList.add('hidden');
            document.getElementById('user-content').classList.remove('hidden');
            document.getElementById('user-display-name').textContent = currentUser.username || currentUser.email;
            document.getElementById('user-email-display').textContent = currentUser.email;
        } else {
            document.getElementById('auth-content').classList.remove('hidden');
            document.getElementById('user-content').classList.add('hidden');
            setAuthMode('login'); 
        }
    }

    function setAuthMode(mode) {
        document.getElementById('btn-mode-login').classList.toggle('active', mode==='login');
        document.getElementById('btn-mode-register').classList.toggle('active', mode==='register');
        const t = TRANSLATIONS[currentLang];
        
        if(mode === 'login') {
            document.getElementById('auth-title').textContent = t.connexion;
            document.getElementById('field-username').classList.add('hidden');
        } else {
            document.getElementById('auth-title').textContent = t.inscription;
            document.getElementById('field-username').classList.remove('hidden');
        }
    }

    async function submitAuth() {
        const authTitle = document.getElementById('auth-title').textContent;
        const t = TRANSLATIONS[currentLang];
        const mode = authTitle === t.connexion ? 'login' : 'register';
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;
        const username = document.getElementById('auth-username').value; 

        if (!email || !password) { alert("Email + Password required"); return; }
        if (mode === 'register' && !username) { alert("Username required"); return; }

        try {
            const endpoint = mode === 'login' ? '/login' : '/register';
            const bodyData = mode === 'login' ? { email, password } : { username, email, password };

            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(bodyData)
            });

            const result = await response.json();

            if (response.ok) {
                if (mode === 'login') currentUser = result.user; 
                else currentUser = { id: result.user_id, username, email };
                
                localStorage.setItem('user_session', JSON.stringify(currentUser));
                
                const profileBtn = document.getElementById('auth-btn'); 
                const initial = (currentUser.username ? currentUser.username.charAt(0) : currentUser.email.charAt(0)).toUpperCase();
                profileBtn.textContent = initial; 
                profileBtn.style.background = "#0b57d0"; 
                profileBtn.style.color = "white";
                
                if (currentSelectedWeekId) loadAllWeekData(currentSelectedWeekId); 
                renderArchives(); 
                updateDashboard();
                checkRealInvites();
                toggleAuthModal();
                alert(mode === 'login' ? `Welcome ${currentUser.username || 'User'}!` : "Account created!");
            } else {
                alert("Error: " + (result.error || "Auth failed"));
            }
        } catch (error) {
            console.error(error);
            alert("Server connection failed. Is Flask running on " + API_BASE_URL + "?");
        }
    }

    async function resetPassword() {
        const email = prompt("Email:");
        if (!email) return;
        const newPass = prompt("New Password:");
        if (!newPass) return;

        try {
            const response = await fetch(`${API_BASE_URL}/update-password`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, new_password: newPass })
            });
            const res = await response.json();
            alert(res.message || res.error);
        } catch (e) {
            alert("Connection error");
        }
    }

    function logout() {
        localStorage.removeItem('user_session');
        currentUser = null;
        
        const b = document.getElementById('auth-btn'); 
        b.textContent = "?"; 
        b.style.background="var(--primary-bg)"; b.style.color="var(--primary)";
        
        toggleAuthModal();
        loadAllWeekData(currentSelectedWeekId); 
        renderArchives(); 
        
        alert("Logged out.");
    }
    
    function generateAdvice() {
        const msgs = { 
            fr: ["‚ú® Chaque geste compte.", "üí° √âteignez le Wifi.", "üöó Covoiturez !", "ü•© Mangez moins de viande.", "üå°Ô∏è Baissez le chauffage de 1¬∞C."], 
            en: ["‚ú® Every act counts.", "üí° Turn off Wifi.", "üöó Carpool!", "ü•© Eat less meat.", "üå°Ô∏è Lower heat by 1¬∞C."],
            es: ["‚ú® Todo cuenta.", "üí° Apaga el Wifi.", "üöó Comparte coche.", "ü•© Menos carne.", "üå°Ô∏è Baja la calefacci√≥n."],
            zh: ["‚ú® ÊØè‰∏ÄÊ≠•ÈÉΩÈáçË¶Å„ÄÇ", "üí° ÈóúÈñâ Wifi„ÄÇ", "üöó ÊãºËªäÂá∫Ë°åÔºÅ", "ü•© Â∞ëÂêÉËÇâ„ÄÇ", "üå°Ô∏è ÊöñÊ∞£Ë™ø‰Ωé 1¬∞C„ÄÇ"]
        };
        const pool = msgs[currentLang] || msgs.fr;
        document.getElementById('advice-text').textContent = pool[Math.floor(Math.random()*pool.length)];
    }

    // --- INIT ---
    window.onload = () => {
        const sl = localStorage.getItem('selected_lang') || 'fr';
        currentLang = sl; document.getElementById('lang-selector').value = sl;
        
        ['courses','transport','digital','elec'].forEach(c => renderWeekNav(c));
        
        if(currentSelectedWeekId) loadAllWeekData(currentSelectedWeekId);
        
        renderArchives();
        renderFriends();
        populateFriendSelects();

        if(currentUser) { 
            const b = document.getElementById('auth-btn'); 
            b.textContent = (currentUser.username ? currentUser.username.charAt(0) : currentUser.email.charAt(0)).toUpperCase(); 
            b.style.background="#0b57d0"; b.style.color="white"; 
            checkRealInvites();
        } else {
            updateDashboard();
        }
        
        updateText();
    };
    
    // --- ROUTE & AUTOCOMPLETE ---
    async function handleAddressInput(inputId, suggestionsId) {
        const query = document.getElementById(inputId).value;
        const container = document.getElementById(suggestionsId);
        
        if (query.length < 3) { container.style.display = 'none'; return; }

        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&addressdetails=1&limit=5`);
            const data = await response.json();
            container.innerHTML = '';
            data.forEach(place => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = place.display_name;
                div.onclick = () => {
                    document.getElementById(inputId).value = place.display_name;
                    document.getElementById(inputId).dataset.lat = place.lat;
                    document.getElementById(inputId).dataset.lon = place.lon;
                    container.style.display = 'none';
                };
                container.appendChild(div);
            });
            container.style.display = 'block';
        } catch(e) { console.error(e); }
    }

    async function calculateRoute() {
        const startInput = document.getElementById('route-start');
        const endInput = document.getElementById('route-end');
        const days = parseInt(document.getElementById('route-days').value) || 1;
        const mode = document.getElementById('route-mode').value;

        if (!startInput.dataset.lat || !endInput.dataset.lat) {
            alert("Selectionnez une adresse dans la liste / Select address from list.");
            return;
        }

        const lat1 = parseFloat(startInput.dataset.lat), lon1 = parseFloat(startInput.dataset.lon);
        const lat2 = parseFloat(endInput.dataset.lat), lon2 = parseFloat(endInput.dataset.lon);

        const R = 6371; 
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        const birdDistance = R * c;

        let ratio = 1.25; 
        if (mode === 'plane') ratio = 1.05; 
        if (mode === 'walk' || mode === 'bike') ratio = 1.15; 

        const kmUnitaire = birdDistance * ratio;
        const totalKm = Math.round(kmUnitaire * 2 * days);

        document.getElementById('route-res').classList.remove('hidden');
        document.getElementById('route-km-val').textContent = totalKm;
    }
    
    function applyRouteKm() {
        const mode = document.getElementById('route-mode').value;
        const kmValue = document.getElementById('route-km-val').textContent;
        const modeToInput = { 'car': 'inp-car', 'public': 'inp-public', 'plane': 'inp-plane', 'walk': 'inp-walk', 'bike': 'inp-bike' };
        const targetInputId = modeToInput[mode];
        if (targetInputId) {
            document.getElementById(targetInputId).value = kmValue;
            switchTransSub('direct');
            calcTransport();
        }
    }
    
    function filterCountries() {
        const v = document.getElementById('country-search').value.toLowerCase();
        const l = document.getElementById('country-list-container');
        l.innerHTML='';
        COUNTRIES.forEach((c) => {
            if(c.name.toLowerCase().includes(v)) {
                const d=document.createElement('div'); d.className='country-item'; d.textContent=c.name;
                d.onclick=()=>{ 
                    currentCountry=c; localStorage.setItem('impact_country', JSON.stringify(c)); 
                    document.getElementById('current-country-display').textContent=c.name; l.style.display='none'; 
                    renderArchives(); updateDashboard();
                };
                l.appendChild(d);
            }
        });
        l.style.display = l.innerHTML ? 'block' : 'none';
    }
</script>
</body>
</html>